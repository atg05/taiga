<!--
This Source Code Form is subject to the terms of the Mozilla Public
License, v. 2.0. If a copy of the MPL was not distributed with this
file, You can obtain one at http://mozilla.org/MPL/2.0/.

Copyright (c) 2023-present Kaleidos INC
-->

<ng-template
  transloco
  let-t>
  <div class="new-step-top-actions">
    <button
      tuiButton
      type="button"
      (click)="previousStep()"
      appearance="tertiary"
      icon="arrow-left">
      {{ t('commons.back') }}
    </button>
  </div>

  <div class="assistant-step-wrapper">
    <form
      class="template-project-form"
      #form="ngForm"
      [formGroup]="templateProjectForm"
      (ngSubmit)="createProject()">
      <h1
        class="new-step-title"
        id="main-area-title">
        Taiga Assistant
      </h1>
      <tg-ui-select
        [label]="t('commons.workspace')"
        type="avatar">
        <tui-select
          tuiTextfieldSize="l"
          formControlName="workspace"
          [valueContent]="content"
          [readOnly]="true">
          {{ t('new_project.choose_workspace') }}
          <tui-data-list-wrapper
            *tuiDataList
            size="l"
            [items]="workspaces"
            [itemContent]="content">
          </tui-data-list-wrapper>
        </tui-select>
      </tg-ui-select>
      <ng-template
        #content
        let-data>
        <div class="workspace-option">
          <tg-ui-avatar
            size="m"
            type="dark"
            [color]="workspace.color"
            [name]="workspace.name">
          </tg-ui-avatar>
          <div class="name">{{ workspace.name }}</div>
        </div>
      </ng-template>

      <!-- Project name -->
      <tg-ui-input [label]="t('common_project.forms.project_name')">
        <input
          formControlName="name"
          data-test="input-name"
          inputRef
          tuiAutoFocus
          maxlength="80" />
        <ng-container inputError>
          <tg-ui-error
            [enabled]="form.submitted"
            data-test="name-required-error"
            error="required">
            {{ t('common_project.forms.project_name_error') }}
          </tg-ui-error>
        </ng-container>
      </tg-ui-input>

      <!-- User role -->
      <tg-ui-input [label]="t('common_project.forms.user_roles')">
        <input
          formControlName="role"
          data-test="input-role"
          inputRef
          tuiAutoFocus
          maxlength="80" />
        <ng-container inputError>
          <tg-ui-error
            [enabled]="form.submitted"
            error="required">
            {{ t('common_project.forms.user_roles_error') }}
          </tg-ui-error>
        </ng-container>
      </tg-ui-input>

      <!-- Organization type -->
      <tg-ui-input [label]="t('common_project.forms.project_organization')">
        <input
          formControlName="organization"
          data-test="input-organization"
          inputRef
          tuiAutoFocus
          maxlength="80" />
        <ng-container inputError>
          <tg-ui-error
            [enabled]="form.submitted"
            error="required">
            {{ t('common_project.forms.project_organization_error') }}
          </tg-ui-error>
        </ng-container>
      </tg-ui-input>

      <!-- Project type -->
      <tg-ui-input [label]="t('common_project.forms.project_type')">
        <input
          formControlName="type"
          data-test="input-type"
          inputRef
          tuiAutoFocus
          maxlength="80" />
        <ng-container inputError>
          <tg-ui-error
            [enabled]="form.submitted"
            error="required">
            {{ t('common_project.forms.project_type_error') }}
          </tg-ui-error>
        </ng-container>
      </tg-ui-input>

      <!-- Project description -->
      <tg-ui-textarea
        [label]="t('common_project.forms.project_description')"
        [optional]="true">
        <tui-text-area
          class="general-textarea"
          formControlName="description"
          data-test="input-description"
          [expandable]="true"
          [maxLength]="200">
          {{ t('common_project.forms.project_description_placeholder') }}
        </tui-text-area>
        <tg-ui-error
          inputError
          [enabled]="form.submitted"
          data-test="description-maxlength-error"
          error="maxlength">
          {{ t('common_project.forms.max_length_error') }}
        </tg-ui-error>
      </tg-ui-textarea>

      <div class="new-step-actions">
        <button
          (click)="previousStep()"
          *ngIf="!stories"
          data-test="cancel-create-project"
          tuiButton
          type="button"
          appearance="tertiary">
          {{ t('commons.cancel') }}
        </button>
        <button
          loading
          iconRight="tai"
          tuiButton
          type="button"
          (click)="initGenerateStories()"
          appearance="primary">
          <ng-container *ngIf="!stories">
            {{ t('common_project.assistant.generate_stories') }}
          </ng-container>
          <ng-container *ngIf="stories">
            {{ t('common_project.assistant.regenerate_stories') }}
          </ng-container>
        </button>
      </div>
    </form>
    <div class="stories-wrapper">
      <div
        class="stories-inner"
        [ngClass]="{
          'stories-loading': !stories
        }">
        <div
          class="loading"
          *ngIf="!stories">
          <div>
            <tui-svg
              class="loading-icon"
              src="tai">
            </tui-svg>
            <span> Blank project </span>
          </div>
          <div class="loading-text">Write a prompt to generate stories</div>
        </div>
        <div
          class="stories-list"
          *ngIf="stories">
          <ng-container
            *ngFor="
              let story of stories;
              index as index;
              trackBy: trackByStoryIndex
            ">
            <tg-assistant-step-card
              [index]="index"
              [story]="story"
              (removeStory)="removeStory($event)"></tg-assistant-step-card>
          </ng-container>
        </div>
      </div>
      <div
        class="new-step-actions"
        *ngIf="stories">
        <button
          (click)="previousStep()"
          data-test="cancel-create-project"
          tuiButton
          type="button"
          appearance="tertiary">
          {{ t('commons.cancel') }}
        </button>
        <button
          (click)="createProject()"
          iconRight="chevron-right"
          data-test="submit-create-project"
          tuiButton
          type="submit"
          appearance="primary">
          {{ t('common_project.create_project') }}
        </button>
      </div>
    </div>
  </div>
</ng-template>
